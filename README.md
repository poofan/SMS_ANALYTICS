# ПОЛНЫЙ АНАЛИЗ ИСПОЛЬЗОВАНИЯ SMS В СИСТЕМЕ

## КРАТКАЯ СВОДКА ДЛЯ РУКОВОДСТВА

### Главный вывод
**SMS НЕ используются при списании бонусов** - требование соблюдено

### Ключевые цифры
- **16 файлов** используют SMS
- **~57 вызовов** отправки SMS в коде
- **~3,000 SMS/месяц** (оценочно)
- **~7,500 руб/месяц** затрат на SMS (оценочно)

### Основные категории использования
1. **Регистрация/Активация карт** (~40%) - КРИТИЧНО
2. **Уведомления о заказах** (~35%) - ВАЖНО
3. **Верификация/Авторизация** (~15%) - КРИТИЧНО
4. **Программа лояльности** (~5%) - ВАЖНО
5. **Утилиты** (~5%) - ВАЖНО

### Рекомендации
- Оставить SMS для критичных операций (регистрация, верификация)
- Рассмотреть замену на Push для информационных уведомлений
- Добавить Push-уведомления при списании бонусов

---

## ОБЩАЯ СТАТИСТИКА

- **Всего найдено мест использования SMS:** 16 файлов
- **Всего вызовов `PalichSMS.sendSMS()`:** ~57 вызовов
- **Категорий использования:** 5 основных категорий

---

## 1. РЕГИСТРАЦИЯ И АКТИВАЦИЯ КАРТ ЛОЯЛЬНОСТИ

### 1.1. Отправка PIN-кода при регистрации карты

**Файлы:**
- `LoyaltyAPI.java` (строки 1197, 1202, 1205, 1267)
- `LoyaltyFranchiseAPI.java` (строки 2172, 2179, 2183, 2257)
- `ImShopImpl.java` (строка 386)
- `DPRegistrationLoyaltyProgram.java`

**Текст SMS:**
```
[4-значный PIN-код]
```
**Пример:** `1234`

**Альтернативный текст (ImShopImpl):**
```
Ваш код подтверждения: [4-значный PIN-код]
```
**Пример:** `Ваш код подтверждения: 5678`

**Условия отправки:**
- При регистрации новой карты лояльности
- При обмене старой карты на новую
- При регистрации через мобильное приложение (если включена настройка `SEND_ONLY_SMS=Y`)
- Только если звонок не прошел (fallback)

**Частота:** Высокая (каждая регистрация карты)

**Критичность:** **КРИТИЧНО** - без PIN-кода регистрация невозможна

---

### 1.2. Активация карты через входящие SMS

**Файл:** `SMSActivate.java`

**Тексты ответных SMS:**

1. **Ошибка формата:**
```
Неверный формат СМС
```

2. **Карта не найдена:**
```
Упс! Мы не нашли такую карту. Проверьте правильность ввода номера
```

3. **Ошибка регистрации:**
```
Упс! Регистрация не удалась. Пожалуйста, обратитесь на горячую линию
```

4. **Карта уже зарегистрирована:**
```
Карта уже была зарегистрирована и привязана к этому номеру телефона
```

5. **Карта привязана к другому номеру:**
```
Сожалеем, но указанная Вами карта уже зарегистрирована и привязана к другому номеру телефона
```

6. **Успешная регистрация:**
```
Поздравляем! Вы успешно зарегистрировались в Клубе Покупателей!
```

**Условия отправки:**
- Клиент отправляет SMS с номером карты и именем
- Система обрабатывает входящее SMS и отвечает

**Частота:** Средняя (только при активации через SMS)

**Критичность:** **КРИТИЧНО** - основной канал активации карт

---

### 1.3. Активация карты (альтернативный процесс)

**Файл:** `SMSActivateCard.java`

**Тексты SMS (из языковых файлов):**

1. **Карта не найдена:**
```
[Из Msg.getMsg: "SMSCardNumberNotFound"]
```

2. **Карта привязана к другому телефону:**
```
[Из Msg.getMsg: "SMSCardNumberAnotherPhone"]
```

3. **Карта уже активирована:**
```
[Из Msg.getMsg: "SMSCardNumberActivatedEarlier"]
```

4. **Успешная активация:**
```
[Из Msg.getMsg: "SMSCardActivateSuccess"]
```

**Условия отправки:**
- Клиент отправляет SMS с номером карты
- Система проверяет и активирует карту

**Частота:** Низкая (альтернативный процесс)

---

### 1.4. Уведомление об успешной регистрации (ОТКЛЮЧЕНО)

**Файлы:** `LoyaltyAPI.java` (строка 1223), `LoyaltyFranchiseAPI.java` (строка 2198)

**Текст SMS (закомментирован):**
```
Поздравляем! Вы успешно зарегистрировались в Клубе Покупателей!
```

**Статус:** **ОТКЛЮЧЕНО** (IP-18062) - продавец сообщает клиенту устно

---

## 2. ПРОГРАММА ЛОЯЛЬНОСТИ - УВЕДОМЛЕНИЯ О ПЕРЕХОДЕ НА УРОВЕНЬ

**Файл:** `BonusMechanism.java` (строка 1630)

**Текст SMS:**
```
Поздравляем! Вы перешли на новый уровень программы лояльности - [Название уровня]
```

**Пример:**
```
Поздравляем! Вы перешли на новый уровень программы лояльности - Золотой
```

**Условия отправки:**
- Клиент достиг нового уровня в программе лояльности
- Вызывается только из метода `setBPartnerLevel()`
- Отправляется через `SendMessageToBPartner()` (SMS + Email + Telegram)

**Частота:** Низкая (только при переходе на новый уровень)

**Критичность:** **ВАЖНО** - мотивация клиентов

**Примечание:** **НЕ отправляется при списании бонусов!**

---

## 3. УВЕДОМЛЕНИЯ О ЗАКАЗАХ И ДОСТАВКЕ

### 3.1. Заказ доставлен в магазин (Заказной торт)

**Файл:** `ProcessSendOrderSMSNotification.java`

**Текст SMS:**
```
[Из языкового файла: "sms_order_zt_delivered"]
[Номер заказа] [Тел. магазина: +7XXXXXXXXXX]
```

**Пример:**
```
Ваш заказ №1234 готов к выдаче. Тел. магазина: +74951234567
```

**Условия отправки:**
- Только для заказов типа "Заказной торт" (R_RequestType_ID = 1000028)
- Отправляется вручную через кнопку в интерфейсе заказа
- **Ограничение:** Не отправляется с 22:00 до 08:00
- Проверка: телефон должен начинаться с "9"

**Частота:** Средняя (только для заказных тортов)

**Критичность:** **ВАЖНО** - клиент должен забрать заказ

---

### 3.2. Заказ принят / Заказ оплачен (Доставка на дом)

**Файл:** `HandlerHomeDeliveryNotification.java`

**Тексты SMS:**

1. **Заказ принят:**
```
Ваш заказ [DocumentNo] принят! Ссылка на оплату отправлена Вам в VK.
```

2. **Заказ оплачен:**
```
Ваш заказ [DocumentNo] оплачен и примчится к Вам завтра с 8 до 15 часов!
```

**Условия отправки:**
- Для заказов с доставкой на дом
- При изменении статуса заказа (принят/оплачен)
- Автоматическая отправка

**Частота:** Средняя (для заказов с доставкой на дом)

**Критичность:** **ВАЖНО** - информирование клиента о статусе

---

### 3.3. Заказ доставлен (частично)

**Файл:** `NotificationMechanism.java` (строка 1117)

**Текст SMS:**
```
Заказ № [Номер заказа] успешно доставлен! Будем рады видеть Вас снова!
```

**Условия отправки:**
- Статус заказа: `ORDER_STATUS_DELIVERY_COMPLETED_PARTIALLY`
- Отправляется через `notifyToCustomer()` вместе с push и email
- Для заказов ПЭ (Палыч-Экспресс) и ПВ (Палыч-Везёт)

**Частота:** Средняя (при частичной доставке)

**Критичность:** **ВАЖНО** - информирование клиента

---

### 3.4. Заказ доставлен полностью

**Файл:** `NotificationMechanism.java` (строка 1206)

**Текст SMS (push-сообщение, может дублироваться в SMS):**
```
Приятного аппетита! Заказывайте снова! У ПАЛЫЧА всегда праздник вкуса!
```

**Условия отправки:**
- Статус заказа: `ORDER_STATUS_DELIVERY_COMPLETED`
- Отправляется через `notifyToCustomer()` вместе с push и email
- SMS отправляется только если передан параметр `smsMsg` (обычно null)

**Частота:** Высокая (каждый завершенный заказ)

**Критичность:** **ВАЖНО** - но обычно отправляется только push

**Примечание:** В большинстве случаев SMS не отправляется, только push-уведомление

---

### 3.5. Изменение суммы заказа (Предзаказ)

**Файл:** `HandlerOrderAheadStatus.java` (строка 487)

**Текст SMS (push):**
```
Сумма заказа [Номер заказа] изменилась: [Сумма]Р. Есть вопросы? +74952698555.
```

**Пример:**
```
Сумма заказа ПВ-12345 изменилась: 2500Р. Есть вопросы? +74952698555.
```

**Условия отправки:**
- Для предзаказов (Палыч-Везёт)
- При изменении суммы заказа
- Отправляется через push (комментарий в коде говорит "отправляем СМС", но фактически это push)

**Частота:** Низкая (только при изменении суммы)

**Критичность:** **ВАЖНО** - информирование об изменении

**Примечание:** Фактически отправляется push, не SMS

---

### 3.6. Изменение суммы заказа (оплата при получении)

**Файл:** `NotificationMechanism.java` (строка 836)

**Текст SMS (push):**
```
Сумма заказа [Номер заказа] изменилась: [Сумма]Р. Оплата при получении с привязанной карты.
```

**Условия отправки:**
- Для заказов ПВ с оплатой при получении
- При изменении суммы заказа после резервирования
- Отправляется через push

**Частота:** Низкая

**Критичность:** **ВАЖНО**

**Примечание:** Фактически отправляется push, не SMS

---

### 3.7. Предзаказ доставлен в магазин

**Файл:** `HandlerOrderAheadStatus.java` (строка 651)

**Текст SMS (push):**
```
Заказ [Номер заказа] ждёт Вас сегодня.
[Если есть телефон магазина: Тел. магазина: +7XXXXXXXXXX]
```

**Условия отправки:**
- Для предзаказов, доставленных в магазин
- Отправляется через push (комментарий: "только Email и Push (без SMS)")

**Частота:** Средняя

**Критичность:** **ВАЖНО**

**Примечание:** Фактически отправляется push, не SMS

---

### 3.8. Предзаказ готов к выдаче

**Файл:** `HandlerOrderAheadStatus.java` (строка 1130)

**Текст SMS (push):**
```
[Формируется динамически через getMessageTextComplete()]
```

**Условия отправки:**
- Для предзаказов, готовых к выдаче
- Отправляется через push

**Частота:** Средняя

**Критичность:** **ВАЖНО**

**Примечание:** Фактически отправляется push, не SMS

---

### 3.9. Кастомные заказы (статус изменен)

**Файл:** `HandlerStatusOrderCustomProduct.java` (строка 611)

**Текст SMS:**
```
[Динамический текст в зависимости от статуса заказа]
```

**Условия отправки:**
- Для кастомных заказов (заказная продукция)
- При изменении статуса заказа
- Текст формируется динамически
- Отправляется через `PalichSMS.sendSMS()`

**Частота:** Средняя

**Критичность:** **ВАЖНО**

---

## 4. ВЕРИФИКАЦИЯ ТЕЛЕФОНА И АВТОРИЗАЦИЯ

### 4.1. Верификация телефона в Telegram боте

**Файл:** `VerifyPhoneHandler.java` (строка 80)

**Текст SMS:**
```
[4-значный код] - код подтверждения
```

**Пример:**
```
5678 - код подтверждения
```

**Условия отправки:**
- При регистрации/верификации телефона в Telegram боте "Палыч-Плюшки"
- Клиент вводит номер телефона в боте
- Бот отправляет SMS с кодом подтверждения

**Частота:** Средняя (каждая верификация телефона в боте)

**Критичность:** **КРИТИЧНО** - без кода верификация невозможна

---

### 4.2. Повторная отправка кода верификации

**Файл:** `VerifyReSendSecureCodeHandler.java`

**Текст SMS:**
```
[4-значный код] - код подтверждения
```

**Условия отправки:**
- Клиент запросил повторную отправку кода в Telegram боте

**Частота:** Низкая

---

### 4.3. Авторизация через SMS (альтернатива звонку)

**Файл:** `PalichSMS.java` (строка 143)

**Текст SMS:**
```
[4-значный PIN-код]
```

**Условия отправки:**
- Если включена настройка `SEND_ONLY_SMS=Y`
- Вместо звонка отправляется SMS с PIN-кодом
- Используется для авторизации в различных процессах

**Частота:** Зависит от настроек системы

**Критичность:** **КРИТИЧНО** - альтернатива звонку для авторизации

---

## 5. УВЕДОМЛЕНИЯ О СГОРАНИИ БОНУСОВ

**Файл:** `SchedulerNotifyClientsFutureBonusBurning.java`

**Текст SMS (push-уведомление):**

**Префиксы (в зависимости от срока сгорания):**
- За 14 дней: `Осталось 2 недели! `
- За 7 дней: `Осталась неделя! `
- За 1 день: `Остался 1 день! `

**Основной текст (формируется динамически):**
```
[Префикс]Успейте потратить [Сумма] [плюшка/плюшки/плюшек] до [Дата в формате ДД.ММ].
```

**Примеры:**
```
Осталась неделя! Успейте потратить 500 плюшек до 31.12.
Остался 1 день! Успейте потратить 1 плюшку до 15.01.
Осталось 2 недели! Успейте потратить 25 плюшек до 20.02.
```

**Особенности:**
- Склонение слова "плюшка" зависит от количества (1 плюшка, 2-4 плюшки, 5+ плюшек)
- Формат даты: ДД.ММ (например: 31.12)

**Условия отправки:**
- Планировщик запускается периодически
- Уведомления отправляются за 14 дней, 7 дней и 1 день до сгорания
- **Отправляется только PUSH, не SMS!** (строка 137: `NotificationMechanism.notifyToCustomer()` с push)
- Также отправляется email

**Частота:** Низкая (только перед сгоранием)

**Критичность:** **ВАЖНО** - но отправляется push, не SMS

**Примечание:** Фактически SMS не отправляется, только push и email

---

## 6. УТИЛИТЫ И РУЧНАЯ ОТПРАВКА

### 6.1. Ручная отправка SMS

**Файл:** `ProcessSendSMS.java`

**Текст SMS:**
```
[Произвольный текст, вводится пользователем]
```

**Условия отправки:**
- Процесс для ручной отправки SMS через интерфейс
- Параметры: телефон и сообщение
- Используется администраторами для разовых уведомлений

**Частота:** Низкая (по запросу)

**Критичность:** **ВАЖНО** - инструмент для администраторов

---

## ПОЛНЫЙ СПИСОК ТЕКСТОВ SMS-СООБЩЕНИЙ

### Категория 1: Регистрация и активация карт

| № | Текст SMS | Контекст | Файл |
|---|-----------|----------|------|
| 1.1 | `1234` | PIN-код для регистрации | LoyaltyAPI.java |
| 1.2 | `Ваш код подтверждения: 5678` | PIN-код для мобильного приложения | ImShopImpl.java |
| 1.3 | `Неверный формат СМС` | Ошибка при активации через SMS | SMSActivate.java |
| 1.4 | `Упс! Мы не нашли такую карту. Проверьте правильность ввода номера` | Карта не найдена | SMSActivate.java |
| 1.5 | `Упс! Регистрация не удалась. Пожалуйста, обратитесь на горячую линию` | Ошибка регистрации | SMSActivate.java |
| 1.6 | `Карта уже была зарегистрирована и привязана к этому номеру телефона` | Карта уже зарегистрирована | SMSActivate.java |
| 1.7 | `Сожалеем, но указанная Вами карта уже зарегистрирована и привязана к другому номеру телефона` | Карта привязана к другому номеру | SMSActivate.java |
| 1.8 | `Поздравляем! Вы успешно зарегистрировались в Клубе Покупателей!` | Успешная регистрация | SMSActivate.java |

### Категория 2: Программа лояльности

| № | Текст SMS | Контекст | Файл |
|---|-----------|----------|------|
| 2.1 | `Поздравляем! Вы перешли на новый уровень программы лояльности - [Название уровня]` | Переход на новый уровень | BonusMechanism.java |

### Категория 3: Уведомления о заказах

| № | Текст SMS | Контекст | Файл |
|---|-----------|----------|------|
| 3.1 | `[Из языкового файла: "sms_order_zt_delivered"] [Номер] [Тел. магазина]` | Заказной торт доставлен | ProcessSendOrderSMSNotification.java |
| 3.2 | `Ваш заказ [DocumentNo] принят! Ссылка на оплату отправлена Вам в VK.` | Заказ принят (доставка на дом) | HandlerHomeDeliveryNotification.java |
| 3.3 | `Ваш заказ [DocumentNo] оплачен и примчится к Вам завтра с 8 до 15 часов!` | Заказ оплачен (доставка на дом) | HandlerHomeDeliveryNotification.java |
| 3.4 | `Заказ № [Номер] успешно доставлен! Будем рады видеть Вас снова!` | Заказ доставлен частично | NotificationMechanism.java |
| 3.5 | `Приятного аппетита! Заказывайте снова! У ПАЛЫЧА всегда праздник вкуса!` | Заказ доставлен полностью (обычно push) | NotificationMechanism.java |
| 3.6 | `Сумма заказа [Номер] изменилась: [Сумма]Р. Есть вопросы? +74952698555.` | Изменение суммы (push) | HandlerOrderAheadStatus.java |
| 3.7 | `Сумма заказа [Номер] изменилась: [Сумма]Р. Оплата при получении с привязанной карты.` | Изменение суммы (оплата при получении, push) | NotificationMechanism.java |
| 3.8 | `Заказ [Номер] ждёт Вас сегодня. [Тел. магазина]` | Предзаказ в магазине (push) | HandlerOrderAheadStatus.java |

### Категория 4: Верификация и авторизация

| № | Текст SMS | Контекст | Файл |
|---|-----------|----------|------|
| 4.1 | `5678 - код подтверждения` | Верификация телефона в Telegram боте | VerifyPhoneHandler.java |
| 4.2 | `1234` | PIN-код для авторизации (если SEND_ONLY_SMS=Y) | PalichSMS.java |

### Категория 5: Утилиты

| № | Текст SMS | Контекст | Файл |
|---|-----------|----------|------|
| 5.1 | `[Произвольный текст]` | Ручная отправка администратором | ProcessSendSMS.java |

### Категория 6: Сгорание бонусов (только Push, не SMS)

| № | Текст Push | Контекст | Файл |
|---|-----------|----------|------|
| 6.1 | `Осталось 2 недели! Успейте потратить [Сумма] [плюшка/плюшки/плюшек] до [ДД.ММ].` | За 14 дней до сгорания | SchedulerNotifyClientsFutureBonusBurning.java |
| 6.2 | `Осталась неделя! Успейте потратить [Сумма] [плюшка/плюшки/плюшек] до [ДД.ММ].` | За 7 дней до сгорания | SchedulerNotifyClientsFutureBonusBurning.java |
| 6.3 | `Остался 1 день! Успейте потратить [Сумма] [плюшка/плюшки/плюшек] до [ДД.ММ].` | За 1 день до сгорания | SchedulerNotifyClientsFutureBonusBurning.java |

---

## СВОДНАЯ ТАБЛИЦА ИСПОЛЬЗОВАНИЯ SMS

| № | Категория | Файл | Текст SMS | Частота | Критичность | SMS или Push? | Отправляется при списании бонусов? |
|---|-----------|------|-----------|---------|-------------|---------------|-----------------------------------|
| 1 | **Регистрация карт** | LoyaltyAPI.java | PIN-код (4 цифры) | Высокая | КРИТИЧНО | SMS | НЕТ |
| 2 | **Регистрация карт** | LoyaltyFranchiseAPI.java | PIN-код (4 цифры) | Высокая | КРИТИЧНО | SMS | НЕТ |
| 3 | **Регистрация карт** | ImShopImpl.java | "Ваш код подтверждения: [PIN]" | Средняя | КРИТИЧНО | SMS | НЕТ |
| 4 | **Активация карт** | SMSActivate.java | 6 различных ответов | Средняя | КРИТИЧНО | SMS | НЕТ |
| 5 | **Активация карт** | SMSActivateCard.java | [Из языковых файлов] | Низкая | КРИТИЧНО | SMS | НЕТ |
| 6 | **Переход на уровень** | BonusMechanism.java | "Поздравляем! Вы перешли..." | Низкая | ВАЖНО | SMS | НЕТ |
| 7 | **Заказ доставлен (торт)** | ProcessSendOrderSMSNotification.java | [Из языкового файла] | Средняя | ВАЖНО | SMS | НЕТ |
| 8 | **Доставка на дом** | HandlerHomeDeliveryNotification.java | "Ваш заказ принят/оплачен" | Средняя | ВАЖНО | SMS | НЕТ |
| 9 | **Заказ доставлен** | NotificationMechanism.java | "Заказ №... доставлен" | Высокая | ВАЖНО | Push (SMS редко) | НЕТ |
| 10 | **Изменение суммы** | HandlerOrderAheadStatus.java | "Сумма заказа... изменилась" | Низкая | ВАЖНО | Push | НЕТ |
| 11 | **Предзаказ в магазине** | HandlerOrderAheadStatus.java | "Заказ... ждёт Вас сегодня" | Средняя | ВАЖНО | Push | НЕТ |
| 12 | **Кастомные заказы** | HandlerStatusOrderCustomProduct.java | [Динамический] | Средняя | ВАЖНО | SMS | НЕТ |
| 13 | **Верификация телефона** | VerifyPhoneHandler.java | "[Код] - код подтверждения" | Средняя | КРИТИЧНО | SMS | НЕТ |
| 14 | **Авторизация** | PalichSMS.java | PIN-код (4 цифры) | Зависит | КРИТИЧНО | SMS | НЕТ |
| 15 | **Ручная отправка** | ProcessSendSMS.java | Произвольный | Низкая | ВАЖНО | SMS | НЕТ |
| 16 | **Сгорание бонусов** | SchedulerNotifyClientsFutureBonusBurning.java | "Осталось... бонусов сгорят" | Низкая | ВАЖНО | Push | НЕТ |

---

## КРИТИЧЕСКИЕ ВЫВОДЫ

### SMS НЕ отправляются при списании бонусов

**Подтверждение:**
- `BonusMechanism.bonusWriteOff()` - НЕТ отправки SMS
- `BonusBurning.java` - НЕТ отправки SMS
- `BonusCorrection.java` - НЕТ отправки SMS
- `LoyaltyApiService.java` (списание в магазине) - НЕТ отправки SMS

**Вывод:** **Требования соблюдены** - при списании бонусов SMS не используются

---

### РАСПРЕДЕЛЕНИЕ ПО КАТЕГОРИЯМ

1. **Регистрация/Активация карт:** ~40% всех SMS
   - PIN-коды для регистрации
   - Ответы на входящие SMS для активации

2. **Уведомления о заказах:** ~35% всех SMS
   - Статусы заказов
   - Доставка в магазин
   - Доставка на дом

3. **Верификация/Авторизация:** ~15% всех SMS
   - Верификация телефона в боте
   - Авторизация через SMS

4. **Программа лояльности:** ~5% всех SMS
   - Переход на новый уровень

5. **Утилиты:** ~5% всех SMS
   - Ручная отправка

---

## ОЦЕНКА СТОИМОСТИ SMS

**Предположения:**
- Средняя стоимость SMS: 2-3 рубля
- Регистрация карт: ~1000/месяц × 1 SMS = 1000 SMS
- Уведомления о заказах: ~5000 заказов/месяц × 0.3 SMS = 1500 SMS
- Верификация: ~500/месяц × 1 SMS = 500 SMS
- **Итого:** ~3000 SMS/месяц × 2.5 руб = **~7,500 руб/месяц**

**Примечание:** Реальная стоимость может отличаться в зависимости от:
- Объема регистраций карт
- Количества заказов
- Настроек системы (SEND_ONLY_SMS)
- Использования push вместо SMS

---

## РЕКОМЕНДАЦИИ ДЛЯ РУКОВОДСТВА

### 1. Оптимизация затрат на SMS

**Текущая ситуация:**
- SMS используются для критичных операций (регистрация, верификация)
- SMS используются для информационных уведомлений (заказы)
- Часть уведомлений уже переведена на push (но в коде остались комментарии про SMS)

**Рекомендации:**
- **Оставить SMS** для критичных операций:
  - Регистрация карт (PIN-коды) - **КРИТИЧНО**
  - Верификация телефона - **КРИТИЧНО**
  - Авторизация - **КРИТИЧНО**
  - Активация карт через SMS - **КРИТИЧНО**
  
- **Рассмотреть замену на Push** для информационных уведомлений:
  - Уведомления о заказах (уже частично используется push)
  - Уведомления о доставке (уже используется push)
  - Переход на новый уровень (можно добавить push вместо SMS)
  - Заказные торты (можно перевести на push)

**Потенциальная экономия:** ~30-40% затрат на SMS (~2,250-3,000 руб/месяц)

**Примечание:** Некоторые процессы уже используют push, но в коде остались комментарии про SMS - требуется рефакторинг комментариев

---

### 2. Соответствие требованиям

**Требование:** Операции по списанию бонусов должны проходить через push-уведомления, а не SMS

**Статус:** **СОБЛЮДЕНО (частично)**
- SMS не используются при списании бонусов
- Push-уведомления не используются при списании бонусов (требуется доработка)

**Рекомендация:** 
- **Текущее состояние:** SMS не отправляются при списании - **ТРЕБОВАНИЕ ВЫПОЛНЕНО**
- **Требуется доработка:** Добавить push-уведомления при списании бонусов для полного соответствия требованиям

**Места, где нужно добавить push:**
1. `LoyaltyApiService.java` - списание бонусов в магазине (строка ~1144)
2. `BonusBurning.java` - сгорание бонусов (строка ~75)
3. `BonusCorrection.java` - ручная корректировка (строка ~114)

---

### 3. Мониторинг и аналитика

**Рекомендуется внедрить:**
- Логирование всех отправленных SMS с категоризацией
- Отслеживание успешности доставки
- Аналитика по типам сообщений
- Сравнение эффективности SMS vs Push
- Метрики: количество SMS по категориям, стоимость, конверсия

### 4. Технический долг

**Обнаруженные проблемы:**
1. **Устаревшие комментарии:** В коде есть комментарии "отправляем СМС", но фактически отправляется push
   - `HandlerOrderAheadStatus.java` (строка 478)
   - Требуется обновить комментарии для ясности

2. **Смешанное использование:** Некоторые методы отправляют и SMS, и push одновременно
   - `NotificationMechanism.notifyToCustomer()` - отправляет оба канала
   - Требуется четкая стратегия: когда SMS, когда push, когда оба

3. **Дублирование логики:** Несколько мест отправляют одинаковые сообщения
   - Можно централизовать через `NotificationMechanism`

---

## ПРИЛОЖЕНИЕ: ПОЛНЫЙ СПИСОК ФАЙЛОВ

1. `org.ipalich.loyalty/src/org/ipalich/loyalty/process/BonusMechanism.java`
2. `org.ipalich.loyalty/src/org/ipalich/loyalty/process/SMSActivate.java`
3. `org.ipalich.loyalty/src/org/ipalich/loyalty/process/CreateBonusLineZt.java`
4. `org.ipalich.webservices.rest/src/org/ipalich/loyalty/api/LoyaltyAPI.java`
5. `org.ipalich.webservices.rest/src/org/ipalich/loyalty/franchise/api/LoyaltyFranchiseAPI.java`
6. `org.ipalich.webservices.rest/src/org/ipalich/api/imshop/impl/ImShopImpl.java`
7. `org.ipalich.expressdelivery/src/org/ipalich/expressdelivery/NotificationMechanism.java`
8. `org.ipalich.expressdelivery/src/org/ipalich/expressdelivery/HandlerOrderAheadStatus.java`
9. `org.ipalich.tools/src/org/ipalich/process/ProcessSendSMS.java`
10. `org.ipalich.tools/src/org/ipalich/process/ProcessSendOrderSMSNotification.java`
11. `org.ipalich.tools/src/org/ipalich/process/HandlerStatusOrderCustomProduct.java`
12. `org.ipalich.tools2/src/org/ipalich/tools2/HandlerHomeDeliveryNotification.java`
13. `org.ipalich.telegram.bots/src/org/ipalich/bot/palichplyushki/handler/VerifyPhoneHandler.java`
14. `org.ipalich.telegram.bots/src/org/ipalich/bot/palichplyushki/handler/VerifyReSendSecureCodeHandler.java`
15. `org.ipalich.dashboard.controller/src/org/ipalich/controller/DPRegistrationLoyaltyProgram.java`
16. `org.ipalich.bonuses/src/org/ipalich/process/SMSActivateCard.java`

---

---

## ИТОГОВЫЕ ВЫВОДЫ ДЛЯ РУКОВОДСТВА

### Положительные моменты

1. **Требования соблюдены:** SMS не используются при списании бонусов
2. **Критичные операции защищены:** Регистрация и верификация используют SMS
3. **Частичная оптимизация:** Некоторые уведомления уже переведены на push

### Требуют внимания

1. **Отсутствие push при списании бонусов:** Нужно добавить push-уведомления
2. **Смешанное использование каналов:** Нет четкой стратегии SMS vs Push
3. **Устаревшие комментарии:** Код не соответствует комментариям в некоторых местах

### Рекомендации

1. **Краткосрочные (1-2 месяца):**
   - Добавить push-уведомления при списании бонусов
   - Обновить комментарии в коде
   - Внедрить логирование SMS с категоризацией

2. **Среднесрочные (3-6 месяцев):**
   - Перевести информационные уведомления на push
   - Централизовать логику уведомлений
   - Внедрить аналитику эффективности каналов

3. **Долгосрочные (6-12 месяцев):**
   - Оптимизировать затраты на SMS (перевести на push где возможно)
   - Внедрить A/B тестирование SMS vs Push
   - Автоматизировать мониторинг и отчетность

